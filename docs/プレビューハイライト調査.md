# プレビュー検索語ハイライト不具合 調査メモ

## 事象

- 検索語でヒットしたファイルを開いたとき、プレビュー内で検索語が**ハイライトされないことがある**（「ときどき付かない」）。
- 例: 検索語「tes」で `YukkuriMovieMaker.deps.json` を開いたとき、該当行にハイライトが付かない。

---

## 処理の流れ

1. **プレビュー取得**  
   `PreviewService.GetPreviewAsync(path, searchQuery)` が呼ばれる。

2. **種別判定**
   - 拡張子から `PreviewHelper.IsCodeFile(ext)` でコードかどうか判定（`.json` はコード扱い）。
   - コードの場合は `currentLanguage = PreviewHelper.GetLanguage(ext)`（例: `"json"`）。

3. **本文取得**
   - `TextFileExtractor` 等でファイル本文を取得。
   - NFC 正規化し、`content.Split('\n')` で `lines` を得る。

4. **シンタックスハイライト（コードのみ）**
   - `highlightCode(toHighlight, currentLanguage)`（JS: Highlight.js）で HTML 化。
   - 戻り値を `\n` で分割して `highlightedLines` とする。
   - **重要**: `lines.Length` と `highlightedLines.Length` は一致している前提。

5. **検索語ハイライト**
   - 行ごとにループ: `originalLine = lines[i]`、`displayLine = highlightedLines[i]`（コードの場合）。
   - 各検索語 `term` について `Regex.IsMatch(originalLine, term)` で一致すれば `hasMatch = true`。
   - コードの場合は `displayLine = HighlightSearchInSyntax(displayLine, term)` で `<mark>` を挿入。

6. **表示**
   - `PreviewLineResult(displayLine, hasMatch)` を `FilePreviewView` に渡し、`@((MarkupString)line.Content)` でレンダリング。

---

## 想定される失敗要因

### A. 行インデックスずれ（`lines` と `highlightedLines` の対応崩れ）

- **内容**: Highlight.js の出力に含まれる改行数が、元の `content` の改行数と異なる場合、`highlighted.Split('\n')` の行数が `lines.Length` と一致せず、`displayLine = highlightedLines[i]` が**別の行**を指す。
- **起きる条件**: 元テキストにない改行が HTML 側で挿入された／逆に改行が消えた、など。
- **確認方法**: 該当ファイル・検索語で再現し、`lines.Length` と `highlightedLines.Length` を比較。ずれていれば原因の候補。

### B. Highlight.js の HTML 構造で検索語がマッチしない

- **内容**: 検索語が 1 つのテキストノードにまとまっておらず、複数の `<span>` に分かれている。かつ、その分かれ方が「閉タグ＋開タグ」以外（例: 空白のみ、別種のタグ）だと、以前の正規表現ではマッチしなかった。
- **対策**: 既に 3 段階マッチを実装済み。
  1. 1 つのテキストノード内に検索語がそのままある場合。
  2. 文字間に「閉タグ＋開タグ」のみがある場合。
  3. 文字間に「任意のタグ・空白」を許す場合。
- **確認方法**: ハイライトが付かなかった行の `displayLine`（Highlight.js 通過直後）をログに出す。診断ログで記録可能（後述）。

### C. 検索語の正規化・エンコードの差

- **内容**: 本文は NFC 正規化済み、検索語も NFC 正規化済み。ただし Highlight.js が一部文字を HTML エンティティ（例: `&#123;`）で出していると、`encodedTerm`（HtmlEncode のみ）ではマッチしない。
- **起きる条件**: 検索語に `<`, `>`, `&` 等が含まれる場合は `HtmlEncode` で対応済み。それ以外の文字が Highlight.js 側でエンティティ化されるかは言語・バージョン依存。
- **確認方法**: 失敗時の `displayLine` を確認し、検索語がエンティティ表記になっていないかを見る。

### D. 例外で握りつぶしている

- **内容**: `HighlightSearchInSyntax` 内の `try/catch` で例外時は `return htmlLine` のため、マッチに失敗したのと同じ見た目になる。
- **確認方法**: デバッグ時に `catch` でブレークするか、一時的に `catch (Exception ex) { return htmlLine + " <!-- " + ex.Message + " -->"; }` などで確認。

---

## 診断ログ（失敗時の記録）

`PreviewService` に以下の診断を入れてある:

1. **行数ずれ**
   - **条件**: コードプレビュー時、`lines.Length != highlightedLines.Length`。
   - **記録**: `[PreviewHighlight] 行数ずれ path=... lines=N highlightedLines=M`（Warning）。
   - **意味**: 原因 A（行インデックスずれ）の候補。

2. **ハイライト未付与**
   - **条件**: その行で `hasMatch == true` かつ `isSourceCode == true` なのに、全検索語を処理したあとの `displayLine` に `"<mark>"` が 1 つも含まれない。
   - **記録**: `[PreviewHighlight] ハイライト未付与 path=... lineIndex1based=... terms=... htmlSample=...`（Warning）。`htmlSample` は `displayLine` の先頭 400 文字（HTML 構造確認用）。
   - **意味**: 「B: HTML 構造でマッチしていない」か「D: 例外」の可能性が高い。`htmlSample` を見れば、Highlight.js がどのようなタグで検索語を分割しているかが分かる。

ログは `ILogger<PreviewService>` 経由で出力される。DEBUG ビルドで `builder.Logging.AddDebug()` を有効にしているため、Visual Studio の「出力」やデバッグコンソールに表示される。

---

## 再現・確認の手順

1. 検索語「tes」で検索し、`*.deps.json` など該当ファイルを開く。
2. ハイライトが付かない行がある場合、デバッグ実行して上記診断ログの有無を確認。
3. ログに `displayLine` が出ていれば、その HTML を元に正規表現やエンコード処理を見直す。

---

## 関連コード

| 箇所 | 役割 |
|-----|------|
| `PreviewService.GetPreviewAsync` | プレビュー全文取得、行分割、検索語マッチ判定、`HighlightSearchInSyntax` 呼び出し |
| `PreviewService.HighlightSearchInSyntax` | シンタックスハイライト済み HTML 行に `<mark>` を挿入（3 段階マッチ） |
| `index.html` の `highlightCode` | Highlight.js でコードを HTML 化 |
| `PreviewHelper.IsCodeFile` / `GetLanguage` | `.json` 等をコード扱いし言語名を返す |
| `FilePreviewView.razor` | `@((MarkupString)line.Content)` で行を HTML として表示 |
