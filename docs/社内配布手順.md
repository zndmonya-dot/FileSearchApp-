# 社内配布手順（全文検索システム）

社内で「全文検索システム」を配布する際の手順です。**MSIX パッケージ**で配布し、**証明書は配布元で用意したものを MSIX とセットで配布**します。

---

## 利用者向け：インストールと起動

### 必要な環境（利用者 PC）

- **Windows 10 または 11（64bit）**
- **証明書（.cer）** … 配布されたものを信頼されたルートにインストール（初回のみ）
- **.NET 8 デスクトップ ランタイム** … MSIX 実行に必要。未インストールの場合は [.NET 8 ダウンロード](https://dotnet.microsoft.com/download/dotnet/8.0) の「ランタイム」をインストールしてください。
- （任意）**Microsoft Office** … Word/Excel のプレビュー表示を使う場合

**利用者 PC に Python のインストールは不要です。** MSIX と証明書とランタイムだけで利用できます。

### 手順

1. **証明書をインストールする（初回のみ）**  
   配布された **証明書ファイル（.cer）** をダブルクリックし、「証明書のインストール」で **「信頼されたルート証明機関」** にインストールしてください。  
   （「ローカル コンピューター」を選択し、次へ進んでインストール）

2. **アプリ（MSIX）をインストールする**  
   配布された **`.msix` ファイル**をダブルクリックし、表示される手順に従ってインストールしてください。インストール後、スタートメニューから「全文検索システム」を起動できます。  
   （.NET ランタイムが未導入の場合は、Windows の案内に従ってランタイムをインストールしてください。）

3. **初回起動後の設定**
   - 画面右上の **設定** をクリック
   - **検索対象フォルダ** に、検索したいフォルダ（例: 社内ファイルサーバのパス `\\server\share`）を追加
   - **保存** をクリック
   - メイン画面の **インデックスを再構築** をクリックし、完了まで待つ
   - 検索ボックスにキーワードを入力して検索

### トラブルシューティング

| 現象 | 確認すること |
|------|----------------|
| MSIX がインストールできない／「不明な発行元」と出る | 配布された証明書を「信頼されたルート証明機関」にインストールしてから、再度 MSIX を実行してください。 |
| アプリが起動しない | .NET 8 デスクトップ ランタイムがインストールされているか確認してください。 |
| Word/Excel のプレビューが出ない | Office がインストールされているか確認。プレビューなしでも検索は利用可能。 |

不明な点は配布元（社内）にお問い合わせください。

---

## 配布者向け：MSIX と証明書を用意する

**配布者に Python は不要です。** .NET 8 SDK があれば MSIX をビルドできます。**利用者 PC も MSIX・証明書・.NET 8 ランタイムだけで利用可能**です（Python 不要）。

### 用意するもの（配布物）

- **MSIX パッケージ**（.msix） … 下記「1. MSIX のビルド」で生成
- **証明書ファイル（.cer）** … 下記「2. 証明書の用意」でエクスポート
- **インストール手順** … `installers\社内配布\インストール手順.txt` をコピーして同梱

---

### 1. MSIX のビルド

1. リポジトリのルートで次を実行します（**`dotnet publish`** で MSIX が生成されます。`dotnet build` だけでは .msix は出ません）。  
   ```powershell
   dotnet publish src\FileSearch.Blazor\FileSearch.Blazor.csproj -f net8.0-windows10.0.19041.0 -c Release
   ```
2. 生成された MSIX の場所は次のとおりです。  
   `src\FileSearch.Blazor\bin\Release\net8.0-windows10.0.19041.0\win10-x64\AppPackages\FileSearch.Blazor_1.0.0.0_Test\FileSearch.Blazor_1.0.0.0_x64.msix`
3. この .msix を **`installers\`** や **`installers\社内配布\`** にコピーして配布用にします。

**MSIX のファイル名とバージョンについて**  
- ファイル名（例: `FileSearch.Blazor_1.0.0.0_x64.msix`）は、**プロジェクト名**・**バージョン**・**アーキテクチャ（x64）** からビルド時に自動で付きます。
- **バージョン（1.0.0.0）** は `src\FileSearch.Blazor\Platforms\Windows\Package.appxmanifest` の `<Identity ... Version="1.0.0.0" />` で決まります。バージョンを上げる場合はこの `Version` を編集してから Release ビルドし直すと、出力される .msix のファイル名のバージョン部分も変わります。

**注意**: ビルド時に「証明書が見つからない」と出る場合は、先に下記「2. 証明書の用意」で署名用証明書を用意し、`FileSearch.Blazor.csproj` の `PackageCertificateThumbprint` にそのサムプリントを設定してください。

---

### 2. 証明書の用意（配布用 .cer の作り方）

MSIX の署名に使っている証明書の **公開部分（.cer）** をエクスポートし、利用者に配布します。利用者はこの .cer を「信頼されたルート証明機関」にインストールしたうえで MSIX をインストールします。

#### 既に署名用証明書がある場合（サムプリントでビルドしている場合）

プロジェクトの `PackageCertificateThumbprint`（例: `1B9840ABF96610DF80AA2D8E189161A99581E4BE`）に対応する証明書が、ビルドする PC の「現在のユーザー」の証明書ストアにインストールされている想定です。

1. **certmgr.msc** を実行（Win + R → `certmgr.msc` 入力）。
2. 左で **「個人」→「証明書」** を開き、一覧から **MSIX 署名に使っている証明書**（サムプリントが csproj の値と一致するもの）を探します。  
   （「発行先」や有効期限で判別できます。右クリック → プロパティ → 「拇印」でサムプリントを確認できます。）
3. その証明書を **右クリック** → **「すべてのタスク」** → **「エクスポート」**。
4. 「次へ」→ **「いいえ、秘密キーをエクスポートしません」** → 次へ。
5. **「DER encoded binary X.509 (.CER)」** を選択 → 次へ。
6. ファイル名を指定（例: `FileSearch_配布用.cer`）→ 次へ → 完了。
7. エクスポートした .cer を配布用フォルダに置きます。

**PowerShell でエクスポートする場合**（サムプリントが `1B9840ABF96610DF80AA2D8E189161A99581E4BE` の例）:

```powershell
$thumb = "1B9840ABF96610DF80AA2D8E189161A99581E4BE"
$cert = Get-ChildItem -Path Cert:\CurrentUser\My | Where-Object { $_.Thumbprint -eq $thumb }
if ($cert) {
  Export-Certificate -Cert $cert -FilePath ".\FileSearch_配布用.cer" -Type CERT
  Write-Host "Exported to FileSearch_配布用.cer"
}
```

#### これから署名用証明書を作る場合（自己署名証明書）

社内用に自己署名証明書を新規作成し、配布用 .cer まで一括で行う場合は、次のスクリプトを使うと簡単です。

1. **スクリプトを実行**（リポジトリのルートで）  
   ```powershell
   .\scripts\create-cert-for-msix.ps1
   ```
   - 現在のユーザーの証明書ストアに「FileSearch MSIX Signing」という自己署名のコード署名証明書が作成されます。
   - 配布用の .cer が `installers\社内配布\FileSearch_配布用.cer` に出力されます。
   - 画面に **Thumbprint（拇印）** が表示されます。

2. **csproj にサムプリントを設定**  
   `src\FileSearch.Blazor\FileSearch.Blazor.csproj` を開き、`PackageCertificateThumbprint` の値を、表示された Thumbprint に書き換えて保存します。  
   （例: `<PackageCertificateThumbprint>表示された20文字×10の拇印</PackageCertificateThumbprint>`）

3. **MSIX をビルド**  
   ```powershell
   dotnet build FullTextSearch.sln -c Release
   ```
   これで新しい証明書で署名された MSIX が生成されます。配布時は、`installers\社内配布\` に出力済みの .cer と、ビルドで出た .msix をセットで配布してください。

**手動で証明書だけ作りたい場合**（PowerShell で 1 つずつ実行）:
- 証明書作成: `New-SelfSignedCertificate -Subject "CN=FileSearch App" -Type CodeSigningCert -CertStoreLocation "Cert:\CurrentUser\My" -FriendlyName "FileSearch MSIX"`
- 拇印確認: `Get-ChildItem Cert:\CurrentUser\My | Where-Object { $_.FriendlyName -eq "FileSearch MSIX" } | Select-Object Thumbprint`
- その後、上記「既に署名用証明書がある場合」の手順で .cer をエクスポートし、csproj の `PackageCertificateThumbprint` に拇印を設定してください。

---

### 3. 配布用フォルダにまとめる

次の 3 つを同じフォルダ（または ZIP）にまとめて配布します。

| ファイル | 説明 |
|----------|------|
| `FileSearch.Blazor_1.0.0.0_x64.msix`（またはビルドで出た .msix） | アプリ本体 |
| `FileSearch_配布用.cer`（または任意の名前の .cer） | 証明書（利用者が信頼されたルートにインストールする） |
| `インストール手順.txt` | `installers\社内配布\インストール手順.txt` のコピー |

利用者には「まず .cer をインストール → 続けて .msix をインストール」と案内してください。

### バージョンアップ時

- ソースを更新し、Release で再ビルドして新しい .msix を生成します。証明書が同じであれば、同じ .cer をそのまま同梱して配布できます。  
- `Package.appxmanifest` の `Version` を上げてからビルドすると、上書きインストールや並行インストールの管理がしやすくなります。

---

## 補足：スタンドアロン exe（ZIP）での配布

証明書を配布・インストールしたくない場合の代替として、スタンドアロン exe を ZIP で配布する方法もあります。

- 配布用ビルド: `scripts\build-dist.bat` を実行すると `installers\dist\FileSearch_win-x64.zip` が生成されます。
- 利用者は ZIP を解凍して `FileSearch.Blazor.exe` を実行します（証明書不要）。  
- 詳細はリポジトリ内の `scripts\build-dist.bat` および publish コマンドのコメントを参照してください。

メインの配布方法は上記の **MSIX + 証明書のセット配布** を推奨します。
