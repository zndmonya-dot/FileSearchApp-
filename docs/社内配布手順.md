# 社内配布手順（全文検索システム）

MSIX と証明書（.cer）をセットで配布するときの手順です。

- **利用者** … 配布された「.cer」と「.msix」を受け取り、インストールして使う人
- **配布者** … アプリをビルドし、.cer と .msix を用意して渡す人（.NET 8 SDK が必要。Python 不要）

---

## 利用者向け：インストール手順（3 ステップ）

### 事前に必要なもの

- Windows 10 または 11（64bit）
- 配布された **証明書（.cer）** と **アプリ（.msix）**
- .NET 8 デスクトップ ランタイム（未導入の場合は [こちら](https://dotnet.microsoft.com/download/dotnet/8.0) の「ランタイム」をインストール）

※ 利用者 PC に Python のインストールは不要です。

---

### ステップ 1：証明書をインストールする（初回のみ）

1. 配布された **証明書ファイル（.cer）** をダブルクリックします。
2. 「証明書のインストール」ウィザードで **「次へ」** をクリックします。
3. **「信頼されたルート証明機関」** を選び、「次へ」→「完了」でインストールします。  
   （「ローカル コンピューター」を選んで進めてください。）

---

### ステップ 2：アプリ（MSIX）をインストールする

1. 配布された **.msix ファイル** をダブルクリックします。
2. 画面の案内に従ってインストールを完了します。
3. スタートメニューに「全文検索システム」が追加されます。ここから起動できます。  
   （.NET ランタイムが入っていない場合は、画面の案内に従ってランタイムをインストールしてください。）

---

### ステップ 3：初回起動後の設定

1. 「全文検索システム」を起動し、画面右上の **設定** をクリックします。
2. **検索対象フォルダ** に、検索したいフォルダ（例: `\\server\share`）を追加し、**保存** をクリックします。
3. メイン画面の **インデックスを再構築** をクリックし、完了するまで待ちます。
4. 検索ボックスにキーワードを入力して検索できます。

---

### 困ったときは

| 症状 | 対処 |
|------|------|
| 「不明な発行元」で MSIX が入れられない | 先に **ステップ 1** の証明書インストールを行ってから、もう一度 .msix を実行してください。 |
| アプリが起動しない | .NET 8 デスクトップ ランタイムが入っているか確認してください。 |
| プレビューが表示されない | プレビューはテキスト抽出表示のため Office は不要です。検索・プレビューは利用できます。ファイルを「開く」には関連アプリが必要です。 |

不明な点は配布元（社内）にお問い合わせください。

---

## 配布者向け：MSIX と証明書を用意する手順

配布するには、次の **3 つ** を同じフォルダにまとめて渡します。

1. **.msix**（アプリ本体）
2. **.cer**（証明書。利用者が信頼されたルートにインストールする）
3. **インストール手順.txt**（`installers\社内配布\インストール手順.txt` をコピーしたもの）

以下で、.msix と .cer の作り方を説明します。

---

### A. 証明書を用意する

#### パターン 1：これから証明書を新規作成する（おすすめ）

1. リポジトリのルートで、次のコマンドを実行します。  
   ```powershell
   .\scripts\create-cert-for-msix.ps1
   ```
2. 画面に表示された **Thumbprint（拇印）** をコピーします。
3. `src\FileSearch.Blazor\FileSearch.Blazor.csproj` を開き、`PackageCertificateThumbprint` の値を、コピーした拇印に書き換えて保存します。
4. スクリプト実行時に、配布用の .cer が **`installers\社内配布\全文検索システム_配布用.cer`** に出力されています。このファイルをそのまま配布に使います。

#### パターン 2：すでに署名用証明書がある（csproj にサムプリントを設定済み）

1. **certmgr.msc** を実行し、「個人」→「証明書」を開きます。
2. MSIX 署名に使っている証明書（csproj の `PackageCertificateThumbprint` と拇印が一致するもの）を右クリック → **「すべてのタスク」** → **「エクスポート」** を選びます。
3. 「いいえ、秘密キーをエクスポートしません」→「DER encoded binary X.509 (.CER)」を選び、ファイル名（例: `全文検索システム_配布用.cer`）を指定してエクスポートします。
4. エクスポートした .cer を配布用フォルダに置きます。

---

### B. MSIX をビルドする

1. リポジトリのルートで、次のコマンドを実行します。  
   **※ `dotnet build` では .msix は出ません。必ず `dotnet publish` を使ってください。**  
   ```powershell
   dotnet publish src\FileSearch.Blazor\FileSearch.Blazor.csproj -f net8.0-windows10.0.19041.0 -c Release
   ```
2. 生成された .msix は、次のフォルダにあります。  
   `src\FileSearch.Blazor\bin\Release\net8.0-windows10.0.19041.0\win10-x64\AppPackages\FileSearch.Blazor_1.0.0.0_Test\FileSearch.Blazor_1.0.0.0_x64.msix`
3. この .msix を、配布用フォルダ（例: `installers\` や `installers\社内配布\`）にコピーします。

**補足**  
- ビルド時に「証明書が見つからない」と出る場合は、先に **A. 証明書を用意する** を完了し、csproj の `PackageCertificateThumbprint` が正しく設定されているか確認してください。  
- バージョンを変えたい場合は、`src\FileSearch.Blazor\Platforms\Windows\Package.appxmanifest` の `Version="1.0.0.0"` を編集してから、上記の publish をやり直してください。

---

### C. 配布用にまとめる

次の 3 つを **同じフォルダ**（または ZIP）にまとめて、利用者に渡します。

| 中身 | 説明 |
|------|------|
| **.msix** | アプリ本体（B でコピーしたファイル） |
| **.cer** | 証明書（A で用意したファイル） |
| **インストール手順.txt** | `installers\社内配布\インストール手順.txt` のコピー |

利用者には「**まず .cer をインストールしてから、.msix をインストールしてください**」と案内してください。

---

### バージョンアップして配布し直すとき

- ソースを直したあと、**B. MSIX をビルドする** の手順で再度 publish し、新しい .msix を生成します。
- 証明書を変えていなければ、同じ .cer をそのまま同梱して配布してかまいません。
- バージョン番号を上げる場合は、`Package.appxmanifest` の `Version` を更新してから publish してください。

---

## 補足：証明書なしで配布したい場合（ZIP 配布）

証明書を渡したくない場合は、スタンドアロン exe を ZIP で配布する方法があります。

- **配布者**：`scripts\build-dist.bat` を実行すると、`installers\dist\FileSearch_win-x64.zip` ができます。この ZIP を渡します。
- **利用者**：ZIP を解凍し、中の `FileSearch.Blazor.exe` を実行します（証明書のインストールは不要）。

通常の配布では、**MSIX ＋ 証明書のセット配布** を推奨します。
