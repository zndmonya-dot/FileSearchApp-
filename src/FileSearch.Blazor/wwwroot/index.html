<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>全文検索システム</title>
    <base href="/" />
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'css/app.css?v=' + new Date().getTime();
        document.head.appendChild(link);
    </script>
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        #blazor-error-ui {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: #ff5252;
            color: white;
            text-align: center;
        }
        #blazor-error-ui.visible { display: block; }
    </style>
</head>
<body>
    <div id="app">
        <div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#666;">
            <div style="text-align:center;">
                <div style="width:40px;height:40px;border:3px solid #e0e0e0;border-top-color:#2563eb;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto;"></div>
                <p style="margin-top:16px;">読み込み中...</p>
            </div>
        </div>
        <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
    </div>

    <div id="blazor-error-ui">
        エラーが発生しました。<a href="" style="color:white;margin-left:8px;">再読み込み</a>
    </div>

    <script src="_framework/blazor.webview.js"></script>
    <script>
        // シンタックスハイライト用のヘルパー関数
        window.highlightCode = function(code, language) {
            if (!language || language === 'text' || language === 'plaintext') {
                return code;
            }
            try {
                if (hljs.getLanguage(language)) {
                    return hljs.highlight(code, { language: language }).value;
                } else {
                    return hljs.highlightAuto(code).value;
                }
            } catch (e) {
                return code;
            }
        };
        /** 複数行を一括でシンタックスハイライト（JS往復を減らしてプレビューを速くする） */
        window.highlightCodeBatch = function(lines, language) {
            if (!lines || !Array.isArray(lines)) return [];
            if (!language || language === 'text' || language === 'plaintext') {
                return lines.slice();
            }
            var result = [];
            try {
                for (var i = 0; i < lines.length; i++) {
                    try {
                        if (hljs.getLanguage(language)) {
                            result.push(hljs.highlight(lines[i], { language: language }).value);
                        } else {
                            result.push(hljs.highlightAuto(lines[i]).value);
                        }
                    } catch (e) {
                        result.push(lines[i]);
                    }
                }
                return result;
            } catch (e) {
                return lines.slice();
            }
        };

        // システムのテーマ設定（prefers-color-scheme）を取得。戻り値: "dark" / "light"
        window.getPreferredColorScheme = function() {
            return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        };
        window.applyHighlighting = function() {
            document.querySelectorAll('pre code:not(.hljs)').forEach((block) => {
                hljs.highlightElement(block);
            });
        };

        // ハイライト間ジャンプ用（戻り値: "行番号|現在番号|総数" または null）
        var _highlightIndex = -1;
        window.resetHighlightNav = function() {
            _highlightIndex = -1;
            document.querySelectorAll('.code-view tr.highlight-current').forEach(function(r) { r.classList.remove('highlight-current'); });
        };
        /** 初回表示用: 最初のハイライトに即座に合わせる（アニメーションなし）。戻り値は scrollToNextHighlight と同じ形式。 */
        window.scrollToFirstHighlightInstant = function() {
            var marks = Array.from(document.querySelectorAll('.file-box mark'));
            if (marks.length === 0) return null;
            _highlightIndex = 0;
            var m = marks[0];
            _applyHighlightCurrent(m);
            m.scrollIntoView({ behavior: 'auto', block: 'center' });
            return _getLineNum(m) + '|' + 1 + '|' + marks.length;
        };
        function _applyHighlightCurrent(mark) {
            document.querySelectorAll('.code-view tr.highlight-current').forEach(function(r) { r.classList.remove('highlight-current'); });
            var row = mark.closest('.code-line') || mark.closest('tr');
            if (row) row.classList.add('highlight-current');
        }
        function _getLineNum(mark) {
            var row = mark.closest('.code-line') || mark.closest('tr');
            if (!row) return 0;
            var td = row.querySelector('.line-number');
            return td ? parseInt(td.textContent, 10) || 0 : 0;
        }
        window.scrollToNextHighlight = function(wrap) {
            if (wrap === undefined) wrap = true;
            var marks = Array.from(document.querySelectorAll('.file-box mark'));
            if (marks.length === 0) return null;
            if (!wrap && _highlightIndex >= marks.length - 1) return null;
            _highlightIndex = wrap ? (_highlightIndex + 1) % marks.length : Math.min(_highlightIndex + 1, marks.length - 1);
            var m = marks[_highlightIndex];
            _applyHighlightCurrent(m);
            m.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return _getLineNum(m) + '|' + (_highlightIndex + 1) + '|' + marks.length;
        };
        window.scrollToPrevHighlight = function(wrap) {
            if (wrap === undefined) wrap = true;
            var marks = Array.from(document.querySelectorAll('.file-box mark'));
            if (marks.length === 0) return null;
            if (!wrap && _highlightIndex <= 0) return null;
            _highlightIndex = wrap ? (_highlightIndex <= 0 ? marks.length - 1 : _highlightIndex - 1) : Math.max(_highlightIndex - 1, 0);
            var m = marks[_highlightIndex];
            _applyHighlightCurrent(m);
            m.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return _getLineNum(m) + '|' + (_highlightIndex + 1) + '|' + marks.length;
        };
    </script>
</body>
</html>
