@page "/"
@using FullTextSearch.Core.Index
@using FullTextSearch.Core.Search
@using FullTextSearch.Core.Models
@using FullTextSearch.Core.Extractors
@using FullTextSearch.Infrastructure.Settings
@using FileSearch.Blazor.Components.Shared
@using Microsoft.Extensions.Logging
@inject ISearchService SearchService
@inject IIndexService IndexService
@inject IAppSettingsService SettingsService
@inject FullTextSearch.Core.Preview.IPreviewService PreviewService
@inject IJSRuntime JSRuntime
@inject ILogger<Home> Logger

<div class="app @(isDarkMode ? "dark" : "light")">
    <AppHeader OnOpenSettings="OpenSettings" />

    <div class="app-container">
        <SearchSidebar SidebarWidth="sidebarWidth"
                      SearchQuery="@searchQuery"
                      SearchQueryChanged="OnSearchQueryChangedAsync"
                      TotalFileCount="totalFileCount"
                      TreeNodes="treeNodes"
                      CurrentPreviewFilePath="@(selectedFile?.FilePath)"
                      HasSearchedCurrentQuery="@HasSearchedCurrentQuery"
                      IsSearching="isSearching"
                      SearchErrorMessage="@SearchErrorMessage"
                      IsIndexing="isIndexing"
                      IndexCount="indexCount"
                      IndexProgressPercent="indexProgressPercent"
                      IndexProgressText="@indexProgressText"
                      IndexErrorMessage="@IndexErrorMessage"
                      OnSearchKeyDown="HandleKeyDown"
                      OnSearchInputChanged="OnSearchInputChanged"
                      OnToggleNode="ToggleNode"
                      OnSelectFile="SelectFile"
                      GetFileIconClass="GetFileIconClass"
                      OnRequestRebuildIndex="RequestRebuildIndex"
                      OnCancelIndexBuild="CancelIndexBuild"
                      OnStartResize="StartResize"
                      GetLastUpdateText="GetLastUpdateText" />

        <main class="main-content">
            @if (selectedFolder != null)
            {
                <FolderListView SelectedFolder="selectedFolder"
                               SortedAndFilteredItems="GetSortedAndFilteredItems(selectedFolder.Children ?? new List<TreeNode>())"
                               SortColumn="sortColumn"
                               SortAscending="sortAscending"
                               FilterType="filterType"
                               ShowFilterMenu="showFilterMenu"
                               SelectedRowIndex="selectedFolderRowIndex"
                               OnSort="SetSort"
                               OnToggleFilterMenu="ToggleFilterMenu"
                               OnFilter="SetFilter"
                               OnRowClick="OnFolderRowClick"
                               GetSortIcon="GetSortIcon"
                               GetUniqueExtensions="GetUniqueExtensions" />
            }
            else if (selectedFile != null)
            {
                <FilePreviewView SelectedFile="selectedFile"
                                 IsLoadingPreview="isLoadingPreview"
                                 PreviewLines="previewLinesDisplay"
                                 PreviewLineCount="previewLineCount"
                                 ShowNavButtons="ShowNavButtons"
                                 NavInfo="@NavInfo"
                                 OnGoPrev="GoPrev"
                                 OnGoNext="GoNext"
                                 OnOpenFile="OpenFile"
                                 OnOpenFolder="OpenFolder"
                                 GetFileIconClass="GetFileIconClass" />
            }
            else
            {
                <div class="empty-state">
                    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"/></svg>
                    <h3>ファイルを選択</h3>
                    <p>左側のツリーからファイルをクリック</p>
                </div>
            }
        </main>
    </div>

    <IndexUpdateDialog Visible="_showRebuildConfirm"
                       FullRebuildSelected="_indexUpdateFullRebuild"
                       FullRebuildSelectedChanged="OnIndexUpdateModeChanged"
                       OnConfirm="ConfirmIndexUpdateAsync"
                       OnCancel="CancelRebuildConfirm" />

    <SettingsModal Visible="showSettings"
                   State="_settingsEdit"
                   LastIndexUpdate="SettingsService.Settings.LastIndexUpdate"
                   OnCloseRequested="CloseSettings"
                   OnSaveRequested="SaveSettings"
                   OnAddFolder="HandleAddFolder"
                   OnRemoveFolder="RemoveFolder"
                   OnAddTargetExtension="HandleAddTargetExtension"
                   OnRemoveTargetExtension="RemoveTargetExtension"
                   OnAddExtensionLanguage="HandleAddExtensionLanguage"
                   OnRemoveExtensionLanguage="RemoveExtensionLanguage"
                   OnOpenIndexFolder="OpenIndexFolder" />
</div>

@if (isResizing)
{
    <div class="resize-overlay" @onmousemove="OnResize" @onmouseup="StopResize" @onmouseleave="StopResize"></div>
}
