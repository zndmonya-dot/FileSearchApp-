@namespace FileSearch.Blazor.Components.Shared
@using FullTextSearch.Core.Models
@using Microsoft.AspNetCore.Components.Rendering
@foreach (var node in Nodes)
{
    @RenderNode(node, 0)
}

@code {
    [Parameter] public IReadOnlyList<TreeNode> Nodes { get; set; } = Array.Empty<TreeNode>();
    [Parameter] public string? CurrentPreviewFilePath { get; set; }
    [Parameter] public EventCallback<TreeNode> OnToggleNode { get; set; }
    [Parameter] public EventCallback<TreeNode> OnSelectFile { get; set; }
    [Parameter] public Func<string, string>? GetFileIconClass { get; set; }

    private bool IsCurrentPreview(TreeNode node) => !node.IsFolder && !string.IsNullOrEmpty(CurrentPreviewFilePath) && string.Equals(node.FilePath, CurrentPreviewFilePath, StringComparison.OrdinalIgnoreCase);

    private RenderFragment RenderNode(TreeNode node, int depth) => __builder =>
    {
        var indent = depth * 16;
        if (node.IsFolder)
        {
            <div class="tree-node folder @(node.IsExpanded ? "expanded" : "")">
                <div class="node-row" style="padding-left: @(8 + indent)px" @onclick="() => OnToggleNode.InvokeAsync(node)">
                    <span class="node-chevron">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M6.22 3.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L9.94 8 6.22 4.28a.75.75 0 0 1 0-1.06Z"/></svg>
                    </span>
                    <span class="node-icon folder">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75Z"/></svg>
                    </span>
                    <span class="node-name">@node.Name</span>
                    @if (node.FileCount > 0)
                    {
                        <span class="node-count">@node.FileCount</span>
                    }
                </div>
                @if (node.IsExpanded && node.Children != null)
                {
                    <div class="node-children">
                        @foreach (var child in node.Children)
                        {
                            @RenderNode(child, depth + 1)
                        }
                    </div>
                }
            </div>
        }
        else
        {
            var iconClass = GetFileIconClass?.Invoke(node.Name) ?? "text";
            <div class="tree-node file">
                <div class="node-row @(IsCurrentPreview(node) ? "current-preview" : "")" style="padding-left: @(8 + indent)px" @onclick="() => OnSelectFile.InvokeAsync(node)">
                    <span class="node-chevron hidden">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M6.22 3.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L9.94 8 6.22 4.28a.75.75 0 0 1 0-1.06Z"/></svg>
                    </span>
                    <span class="node-icon file @iconClass">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"/></svg>
                    </span>
                    <span class="node-name">@node.Name</span>
                </div>
            </div>
        }
    };
}
